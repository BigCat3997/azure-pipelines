parameters:
  - name: workDir
    displayName: Working directory
    type: string
    default: $(System.DefaultWorkingDirectory)

  - name: javaVersion
    displayName: Java's version
    type: number
    default: 17
    values:
      - 8
      - 11
      - 17

  - name: isUseFeed
    displayName: Connect to Azure Feed
    type: boolean
    default: false

  - name: mavenOpts
    displayName: Maven opts
    type: string
    default: ''

  - name: mavenGoals
    displayName: Maven goals
    type: string
    default: 'clean install -B -e'

  - name: mavenCacheFolder
    displayName: Maven cache folder
    type: string
    default: $(Pipeline.Workspace)/.m2/repository

  - name: outputFolder
    displayName: Output folder
    type: string
    default: 'target'

  - name: preSteps
    type: stepList
    default: []

  - name: postSteps
    type: stepList
    default: []

steps:
  - ${{ parameters.preSteps }}

  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '${{ parameters.javaVersion }}'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: Set Java ${{ parameters.javaVersion }}

  - task: Cache@2
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: ${{ parameters.mavenCacheFolder }}
    displayName: Cache Maven local repo

  - bash: |
      mvn clean package -Dmaven.repo.local=${MAVEN_CACHE_FOLDER}
    env:
      MAVEN_CACHE_FOLDER: ${{ parameters.mavenCacheFolder }}
    workingDirectory: ${{ parameters.workDir }}
    displayName: Maven Build

  - task: CopyFiles@2
    displayName: 'Copy libs to: $(build.artifactstagingdirectory)'
    inputs:
      SourceFolder: '${{ parameters.workDir }}/${{ parameters.outputFolder }}'
      Contents: |
        *.jar
      TargetFolder: '$(build.artifactstagingdirectory)'
      CleanTargetFolder: false
      OverWrite: true

  # - ${{ if eq(parameters.isConnectToFeed, true) }}:
  #     - task: MavenAuthenticate@0
  #       displayName: 'Maven Authenticate'
  #       inputs:
  #         artifactsFeeds: devops-feed

  - ${{ parameters.postSteps }}
